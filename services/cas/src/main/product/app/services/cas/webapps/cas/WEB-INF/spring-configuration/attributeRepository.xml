<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	   xmlns:p="http://www.springframework.org/schema/p"
	   xmlns:c="http://www.springframework.org/schema/c"
	   xmlns:ldaptive="http://www.ldaptive.org/schema/spring-ext"
	   xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
	   http://www.ldaptive.org/schema/spring-ext http://www.ldaptive.org/schema/spring-ext.xsd">

	<!-- https://apereo.github.io/cas/4.2.x/integration/Attribute-Resolution.html -->
	<bean id="attributeRepository"
		  class="org.jasig.services.persondir.support.CascadingPersonAttributeDao">
		<property name="merger">
			<bean class="org.jasig.services.persondir.support.merger.JoiningAttributeMerger" p:joinAttributeName="entryDn" />
		</property>
		<property name="personAttributeDaos">
			<list>
				<ref bean="ldapUserAttributeRepository" />
				<ref bean="ldapGroupAttributeRepository" />
			</list>
		</property>
	</bean>

	<bean id="ldapUserAttributeRepository"
		  class="org.jasig.services.persondir.support.ldap.LdaptivePersonAttributeDao"
		  p:connectionFactory-ref="pooledLdapConnectionFactory"
		  p:baseDN="${ldap.usersDn}"
		  p:searchControls-ref="searchControls"
		  p:searchFilter="(&amp;(objectClass=${ldap.user.class})(${ldap.user.rdn.attr}={0}))">
		<property name="queryAttributeMapping">
			<map>
				<entry key="username" value="${ldap.user.rdn.attr}" />
			</map>
		</property>
		<property name="resultAttributeMapping">
			<map>
				<entry key="${ldap.dn.attr}" value="${cas.attr.dn}" />
				<entry key="${ldap.user.rdn.attr}" value="${cas.attr.uid}" />
				<entry key="${ldap.user.commonname.attr}" value="${cas.attr.commonname}"/>
				<entry key="${ldap.user.firstname.attr}" value="${cas.attr.firstname}"/>
				<entry key="${ldap.user.lastname.attr}" value="${cas.attr.lastname}"/>
				<entry key="${ldap.user.displayname.attr}" value="${cas.attr.displayname}"/>
				<entry key="${ldap.user.mail.attr}" value="${cas.attr.mail}" />
				<entry key="${ldap.user.telephone.attr}" value="${cas.attr.telephone}" />
				<entry key="${ldap.user.organization.attr}" value="${cas.attr.organization}" />
			</map>
		</property>
	</bean>

	<bean id="ldapGroupAttributeRepository"
		  class="org.jasig.services.persondir.support.ldap.LdaptivePersonAttributeDao"
		  p:connectionFactory-ref="pooledLdapConnectionFactory"
		  p:baseDN="${ldap.groupsDn}"
		  p:searchControls-ref="searchControls"
		  p:searchFilter="(&amp;(objectClass=${ldap.group.class})(${ldap.group.member.attr}={0}))"
		  p:unmappedUsernameAttribute="${ldap.group.rdn.attr}">
		<property name="queryAttributeMapping">
			<map>
				<entry key="${cas.attr.dn}" value="${ldap.group.member.attr}" />
			</map>
		</property>
		<property name="resultAttributeMapping">
			<map>
				<entry key="${ldap.group.rdn.attr}" value="${cas.attr.groups}" />
				<entry key="${ldap.group.member.attr}" value="${cas.attr.dn}" />
			</map>
		</property>
	</bean>

	<bean id="searchControls"
		  class="javax.naming.directory.SearchControls"
		  p:searchScope="2"
		  p:countLimit="100"
		  p:timeLimit="10000"
	/>

</beans>
